name: Secret Scan (Windows)

on:
  workflow_dispatch:

jobs:
  gitleaks:
    runs-on: [ self-hosted, windows, x64, TENAT, HO-DOCKER-22, NEW ]
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download gitleaks
        run: |
          $version = '8.18.1'
          $zip = "$env:TEMP\gitleaks.zip"
          Invoke-WebRequest -Uri "https://github.com/gitleaks/gitleaks/releases/download/v$version/gitleaks_${version}_windows_x64.zip" -OutFile $zip
          Expand-Archive -Force $zip -DestinationPath $env:TEMP
          Copy-Item "$env:TEMP\gitleaks.exe" "$env:RUNNER_TEMP\gitleaks.exe" -Force
      - name: Run gitleaks
        run: |
          & "$env:RUNNER_TEMP\gitleaks.exe" detect --source . --no-banner --redact --report-path $env:TEMP\gitleaks-report.json
      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-windows
          path: ${{ env.TEMP }}\gitleaks-report.json

