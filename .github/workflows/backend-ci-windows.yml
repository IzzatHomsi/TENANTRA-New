name: Backend CI (Windows)

on:
  workflow_dispatch:

jobs:
  backend:
    name: Lint, test & security (Windows)
    runs-on: [ self-hosted, windows, x64, TENAT, HO-DOCKER-22, NEW ]
    defaults:
      run:
        shell: pwsh
    env:
      PYTHONUNBUFFERED: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONPATH: ${{ github.workspace }}\backend
      CI_DB_PASSWORD: ${{ secrets.CI_DB_PASSWORD }}
      DATABASE_URL: postgresql://tenantra:${{ secrets.CI_DB_PASSWORD }}@localhost:5432/tenantra
      DB_URL: postgresql://tenantra:${{ secrets.CI_DB_PASSWORD }}@localhost:5432/tenantra
      JWT_SECRET: "ci-test-secret"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy bandit pytest alembic

      - name: Start Postgres (Docker) if available
        run: |
          if (Get-Command docker -ErrorAction SilentlyContinue) {
            docker rm -f ci-postgres 2>$null | Out-Null
            docker run -d --name ci-postgres -p 5432:5432 `
              -e POSTGRES_USER=tenantra `
              -e POSTGRES_PASSWORD=$env:CI_DB_PASSWORD `
              -e POSTGRES_DB=tenantra postgres:14 | Out-Null
            $ok=$false; foreach ($i in 1..30) {
              try { $r = Test-NetConnection -ComputerName localhost -Port 5432 -WarningAction SilentlyContinue; if ($r.TcpTestSucceeded) { $ok=$true; break } } catch {}
              Start-Sleep -Seconds 2
            }
            if (-not $ok) { Write-Error "Postgres did not become ready" }
          } else {
            Write-Host "Docker not available on runner; assuming a local Postgres is present on 127.0.0.1:5432."
          }

      - name: Run database migrations
        working-directory: backend
        run: alembic upgrade head

      - name: Seed database
        working-directory: backend
        env:
          SEED_ADMIN_PASSWORD: Admin@1234
        run: python -m app.scripts.db_seed

      - name: Ruff (lint)
        working-directory: backend
        run: ruff check .

      - name: Mypy (type check)
        working-directory: backend
        run: mypy --config-file mypy.ini app

      - name: Bandit (security scan)
        working-directory: backend
        run: bandit -r app -c bandit.yaml -q

      - name: Pytest
        working-directory: backend
        run: pytest -q --maxfail=1 --disable-warnings --junitxml=reports\junit.xml

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-backend-windows
          path: backend\reports\junit.xml

      - name: Generate OpenAPI and verify snapshot freshness
        working-directory: .
        run: |
          python backend\tools\generate_openapi.py --output openapi.generated.json
          $diff = git diff --no-index --text openapi.json openapi.generated.json; if ($LASTEXITCODE -ne 0) { echo $diff; Write-Error "OpenAPI snapshot is outdated" }
          Remove-Item -Force openapi.generated.json

      - name: Cleanup Postgres
        if: always()
        run: |
          if (Get-Command docker -ErrorAction SilentlyContinue) { docker rm -f ci-postgres 2>$null | Out-Null }

