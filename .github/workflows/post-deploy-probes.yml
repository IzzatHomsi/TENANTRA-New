name: Post-Deploy Probes

on:
  workflow_dispatch: {}

env:
  STAGING_DOMAIN: Tenantra.homsi-co.com

jobs:
  probes:
    runs-on: [ self-hosted, windows, TENAT, HO-DOCKER-22 ]
    steps:
      - name: Probe /health
        shell: pwsh
        run: |
          $uri = "https://${{ env.STAGING_DOMAIN }}/health"
          Write-Host "GET $uri"
          $resp = Invoke-WebRequest -UseBasicParsing -TimeoutSec 20 -Uri $uri
          if ($resp.StatusCode -ne 200) { throw "Unexpected status: $($resp.StatusCode)" }

      - name: Probe /openapi.json
        shell: pwsh
        run: |
          $uri = "https://${{ env.STAGING_DOMAIN }}/openapi.json"
          Write-Host "GET $uri"
          $resp = Invoke-WebRequest -UseBasicParsing -TimeoutSec 20 -Uri $uri
          if ($resp.StatusCode -ne 200) { throw "Unexpected status: $($resp.StatusCode)" }
          if (-not $resp.Content -or $resp.Content.Length -lt 5000) { throw "OpenAPI too small or empty" }

