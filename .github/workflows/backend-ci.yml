---
name: Backend CI

on:
  pull_request:
    paths:
      - 'backend/**'
      - 'docker/**'
      - '.github/workflows/backend-ci.yml'
  push:
    branches: [main]
    paths:
      - 'backend/**'
      - 'docker/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  preflight:
    name: Preflight checks
    runs-on: ubuntu-latest
    steps:
      - name: Verify CI_DB_PASSWORD secret exists
        run: |
          if [ -z "${{ secrets.CI_DB_PASSWORD }}" ]; then
            echo "ERROR: secrets.CI_DB_PASSWORD is not set."
            echo "Add it in repository Settings → Secrets → Actions."
            exit 1
          fi
          echo "secrets.CI_DB_PASSWORD is set."

  backend:
    needs: preflight
    name: Lint, test & security on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    services:
      postgres:
        if: matrix.os == 'ubuntu-latest'
        image: postgres:14
        ports: ["5432:5432"]
        env:
          POSTGRES_USER: tenantra
          POSTGRES_PASSWORD: ${{ secrets.CI_DB_PASSWORD }}
          POSTGRES_DB: tenantra
        options: >-
          --health-cmd "pg_isready -U tenantra"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      CI_DB_PASSWORD: ${{ secrets.CI_DB_PASSWORD }}
      DATABASE_URL: >-
        postgresql://tenantra:${{ secrets.CI_DB_PASSWORD }}@localhost:5432/tenantra
      DB_URL: >-
        postgresql://tenantra:${{ secrets.CI_DB_PASSWORD }}@localhost:5432/tenantra
      POSTGRES_USER: tenantra
      POSTGRES_PASSWORD: ${{ secrets.CI_DB_PASSWORD }}
      POSTGRES_DB: tenantra
      POSTGRES_HOST: localhost
      POSTGRES_PORT: "5432"
      PYTHONPATH: ${{ github.workspace }}/backend
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy bandit pytest alembic

      - name: Start Postgres (Docker) if available
        if: matrix.os == 'windows-latest'
        run: |
          if (Get-Command docker -ErrorAction SilentlyContinue) {
            docker rm -f ci-postgres 2>$null | Out-Null
            docker run -d --name ci-postgres -p 5432:5432 `
              -e POSTGRES_USER=tenantra `
              -e POSTGRES_PASSWORD=$env:CI_DB_PASSWORD `
              -e POSTGRES_DB=tenantra postgres:14 | Out-Null
            $ok=false
            foreach ($i in 1..30) {
              try {
                $r = Test-NetConnection -ComputerName localhost -Port 5432 `
                  -WarningAction SilentlyContinue
                if ($r.TcpTestSucceeded) {
                  $ok=true
                  break
                }
              } catch {}
              Start-Sleep -Seconds 2
            }
            if (-not $ok) {
              Write-Error "Postgres did not become ready"
            }
          } else {
            Write-Host "Docker not available on runner; "
            Write-Host "assuming a local Postgres is present on 127.0.0.1:5432."
          }
        shell: pwsh

      - name: Verify migration tracking matches git
        if: matrix.os == 'ubuntu-latest'
        run: python backend/scripts/verify_migration_tracking.py

      - name: Check for untracked migration files
        if: matrix.os == 'ubuntu-latest'
        working-directory: backend
        run: python scripts/check_untracked_migrations.py

      - name: Run database migrations
        working-directory: backend
        run: alembic upgrade head

      - name: Verify migrations applied (debug)
        if: matrix.os == 'ubuntu-latest'
        working-directory: backend
        run: |
          alembic current || true
          alembic heads || true
          ls -la alembic/versions || true
          python scripts/check_migrations.py

      - name: Seed database
        working-directory: backend
        env:
          SEED_ADMIN_PASSWORD: Admin@1234
        run: python -m app.scripts.db_seed

      - name: Ruff (lint)
        working-directory: backend
        run: ruff check .

      - name: Mypy (type check)
        working-directory: backend
        run: mypy --config-file mypy.ini app

      - name: Bandit (security scan)
        working-directory: backend
        run: bandit -r app -c bandit.yaml -q

      - name: Pytest
        working-directory: backend
        run: pytest -q

      - name: Generate OpenAPI and verify snapshot freshness (Linux)
        if: matrix.os == 'ubuntu-latest'
        working-directory: .
        run: |
          python backend/tools/generate_openapi.py --output openapi.generated.json
          if ! diff -u openapi.json openapi.generated.json; then
            echo "OpenAPI snapshot is outdated. Regenerate via: "
            echo "python backend/tools/generate_openapi.py --output openapi.json" >&2
            exit 1
          fi
          rm -f openapi.generated.json

      - name: Generate OpenAPI and verify snapshot freshness (Windows)
        if: matrix.os == 'windows-latest'
        working-directory: .
        run: |
          python backend\tools\generate_openapi.py --output openapi.generated.json
          $diff = git diff --no-index --text openapi.json `
            openapi.generated.json
          if ($LASTEXITCODE -ne 0) {
            echo $diff
            Write-Error "OpenAPI snapshot is outdated"
          }
          Remove-Item -Force openapi.generated.json
        shell: pwsh

      - name: Cleanup Postgres (Windows)
        if: always() && matrix.os == 'windows-latest'
        run: |
          if (Get-Command docker -ErrorAction SilentlyContinue) {
            docker rm -f ci-postgres 2>$null | Out-Null
          }
        shell: pwsh
