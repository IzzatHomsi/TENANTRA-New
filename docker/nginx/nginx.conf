user  nginx;
worker_processes  auto;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events { worker_connections  1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile        on;
  keepalive_timeout  65;

  # Compression (gzip). Brotli requires a separate module; not enabled in base image.
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_vary on;
  gzip_proxied any;
  gzip_types
    text/plain text/css text/javascript application/javascript application/x-javascript
    application/json application/manifest+json application/xml application/rss+xml
    image/svg+xml font/ttf font/otf application/vnd.ms-fontobject application/font-sfnt;
  # Serve precompressed .gz files if present alongside assets
  gzip_static on;

  # Security headers are applied per server (see conf.d/default.conf).

  # Virtual hosts (extend via conf.d/*.conf)
  include /etc/nginx/conf.d/*.conf;

  server {
  listen 80;
    server_name _;

    # Frontend (Vite dev or built FE)
    location / {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  # Frontend runtime serves static files on port 80 inside the frontend container
  proxy_pass http://frontend:80;
    }

    # Backend API
    location /api/ {
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://backend:5000/;
    }

    # Health
    location /healthz {
      proxy_pass http://backend:5000/healthz;
    }
  }
}

